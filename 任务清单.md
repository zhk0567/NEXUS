# NEXUS 项目改进任务清单

> 创建时间：2025-01-XX  
> 基于用户反馈整理的18项改进任务

---

## 📋 任务总览

- **总任务数**：18项
- **Story App相关**：3项（任务1, 4, 12）
- **UI/UX改进**：5项（任务2, 3, 7, 8, 14）
- **AI对话功能**：7项（任务5, 6, 9, 10, 11, 13, 18）
- **登录和设置**：3项（任务15, 16, 17）

### 📈 任务完成进度

- **已完成任务**：14项
- **进行中任务**：0项
- **待处理任务**：1项
- **暂停任务**：3项（任务3、16、17）
- **完成进度**：**77.8%** (14/18)

**已完成任务列表**：
- ✅ 任务1：Story app 图标替换（图标部分）
- ✅ 任务2：字体大小差异优化
- ✅ 任务4：阅读故事音频轨道问题修复
- ✅ 任务5：AI名称一致性修复
- ✅ 任务7：语音悬浮球跟随问题修复
- ✅ 任务8：主题设置添加字体大小选项
- ✅ 任务10：会话ID功能增强（随任务15删除账户详情）
- ✅ 任务11：Deepseek 联网搜索功能（包含日期查询和编码问题修复）
- ✅ 任务12：Story app 完成度计算方式改进
- ✅ 任务6：语音思考卡住问题修复（添加超时自动恢复机制）
- ✅ 任务13：新话题功能优化
- ✅ 任务14：历史对话图标重新设计
- ✅ 任务15：登录时间显示问题修复（删除账户详情）
- ✅ 任务18：AI对话刷新功能优化

---

## 📖 Story App 相关任务

### 1. Story app 图标和内容替换
- **优先级**：高
- **状态**：✅ 已完成（图标部分）
- **描述**：
  - ✅ Story app 图标已替换为 AI 聊天 app 的图标（两个app现在使用相同图标）
  - ⏳ 替换 "Elderly Expo" 的故事内容（待处理）
  - ⏳ 历史故事显示功能（待处理）
- **涉及模块**：`story_control_app`
- **预计工作量**：中等
- **完成时间**：2025-01-XX

### 4. 阅读故事音频轨道问题
- **优先级**：中
- **状态**：✅ 已完成
- **描述**：阅读故事时，阅读前后出现 2 个音频轨道，可能是网络信号问题
- **涉及模块**：`story_control_app` - 音频播放相关
- **预计工作量**：中等
- **完成时间**：2025-01-XX
- **修改内容**：
  - 在开始播放前，先释放旧的MediaPlayer实例，防止多个音频轨道同时存在
  - 在退出音频页面时，停止并释放MediaPlayer，而不是只暂停
  - 在音频播放完成或出错时，自动释放MediaPlayer
  - 在故事切换时，释放旧的MediaPlayer
  - 添加DisposableEffect确保组件销毁时释放MediaPlayer
  - 修复了多个MediaPlayer实例同时存在导致的多个音频轨道问题

### 12. Story app 完成度计算方式改进
- **优先级**：中
- **状态**：✅ 已完成
- **描述**：完成度计算改为基于滑动行为，而非位置（参考淘宝）
- **涉及模块**：`story_control_app` - 进度计算
- **预计工作量**：中等
- **完成时间**：2025-01-XX
- **修改内容**：
  - 进度基于累计滑动距离，而非滚动位置（position）
  - 每次滑动时累加滑动距离（positionDiff），进度 = 累计滑动距离 / 总长度
  - 进度每次最多增长1%，避免过快增长，确保平滑加载
  - 完成按钮仅在进度达到100%时显示
  - 移除了所有时间相关的进度计算（readingDuration、timeProgress等）
  - 移除了倒计时显示（"还需X秒"），不再显示剩余时间
  - 进度更新仅与滑动行为相关，与位置无关
  - 不滑动时，进度不会增长
  - 参考淘宝的完成度计算方式，简化了进度计算逻辑

---

## 🎨 UI/UX 改进任务

### 2. 字体大小差异优化
- **优先级**：中
- **状态**：✅ 已完成
- **描述**：当前字体大小差异不明显，需要增大差异使其更加明显
- **涉及模块**：`app` + `story_control_app` - 字体设置
- **预计工作量**：低
- **完成时间**：2025-01-XX
- **修改内容**：
  - **AI对话app**: Medium和Large字体各增大2-4sp，现在Small到Medium差异+6sp，Medium到Large差异+6sp
  - **Story app**: SMALL减小2sp，MEDIUM增大2sp，LARGE增大6sp，现在SMALL到MEDIUM差异+6sp，MEDIUM到LARGE差异+6sp

### 3. 护眼模式功能
- **优先级**：低（可选）
- **状态**：⏸️ 暂停
- **描述**：添加护眼模式开关功能
- **涉及模块**：`app` - 主题设置
- **预计工作量**：中等
- **备注**：暂时不做处理

### 7. 语音悬浮球跟随问题
- **优先级**：中
- **状态**：✅ 已完成
- **描述**：修复语音悬浮球不紧密跟随的问题（当前为半跟随状态）
- **涉及模块**：`app` - 语音界面
- **预计工作量**：中等
- **完成时间**：2025-01-XX
- **修改内容**：
  - 拖动时直接使用原始位置值（`offsetX`/`offsetY`），不使用动画，实现紧密跟随
  - 拖动结束后使用动画值（`animatedOffsetX`/`animatedOffsetY`），实现平滑的贴边效果
  - 动画配置：拖动时 `tween(0)` 无延迟，拖动结束后 `tween(300)` 平滑过渡
  - 修复了"半跟随"问题，现在悬浮球会紧密跟随手指移动

### 8. 主题设置添加字体大小选项
- **优先级**：高
- **状态**：✅ 已完成
- **描述**：在主题设置中添加字体大小选项
- **涉及模块**：`app` - 主题设置界面
- **预计工作量**：低
- **完成时间**：2025-01-XX
- **修改内容**：
  - 在设置页面的主题设置词条描述中补充了"字体大小"
  - 将subtitle从"跟随系统、深色模式、亮色模式"更新为"跟随系统、深色模式、亮色模式、字体大小"
  - 用户可以在设置页面看到主题设置包含字体大小选项

### 14. 历史对话图标重新设计
- **优先级**：中
- **状态**：✅ 已完成
- **描述**：
  - 改为侧边栏图标（类似 Deepseek）
  - 设计放在历史对话框内（历史对话下方，参考 ChatGPT app）
- **涉及模块**：`app` - 历史对话界面
- **预计工作量**：中等
- **完成时间**：2025-01-XX
- **修改内容**：
  - ✅ 删除左上角的设置入口，只保留历史记录按钮
  - ✅ 在HistoryDrawer组件左下角添加设置图标按钮
  - ✅ 设置按钮包含图标和"设置"文字，类似Deepseek侧边栏风格
  - ✅ 点击设置按钮会关闭历史对话抽屉并打开设置页面
  - ✅ 使用Spacer和weight布局确保设置按钮固定在底部
  - ✅ 为设置按钮添加淡入动画效果（延迟150ms，300ms动画时长），随抽屉打开而出现

---

## 🤖 AI 对话功能任务

### 5. AI 名称一致性修复
- **优先级**：高
- **状态**：✅ 已完成
- **描述**：
  - 实时语音通话：AI 自称 "Doubao"
  - 文本聊天界面：AI 自称 "Xiaonuan"（或"小助手"）
  - 需要统一名称，保持一致性
- **涉及模块**：`app` + `backend/ai_service.py` - AI 对话模块
- **预计工作量**：低
- **完成时间**：2025-01-XX
- **修改内容**：
  - 统一AI名称为"小美"
  - 在文本聊天的系统提示词（SYSTEM_PROMPT）中添加"名字叫小美"
  - 语音通话已使用"小美"名称（bot_name和system_role中）
  - 现在两个界面都统一使用"小美"作为AI名称，保持一致性

### 6. 语音思考卡住问题
- **优先级**：高
- **状态**：✅ 已完成
- **描述**：
  - 语音识别时思考过程卡住
  - 可能因声音太小导致无法识别
  - 当前只能退出重进解决
- **涉及模块**：`app` - 语音识别模块
- **预计工作量**：高
- **完成时间**：2025-11-29
- **修改内容**：
  - 在 `VoiceCallComposeActivity` 和 `VoiceCallViewModel` 中添加响应超时检测机制
  - 当 `isWaitingForResponse` 设置为 true 时，启动30秒超时定时器
  - 如果超过30秒未完成处理，自动恢复初始状态（重置等待状态、录音状态、播放状态）
  - 当收到AI响应（文本输出、音频数据、响应完成）时，自动停止超时检测
  - 在 `RealtimeWebSocketClient` 中，当语音识别超时（5秒）强制发送结束信号后，立即调用 `onResponseComplete()` 重置界面状态
  - 解决了语音识别时思考过程卡住的问题，用户无需退出重进即可自动恢复
  - 一旦出现强制结束信号，界面立即恢复，不再卡在思考阶段

### 9. TTS 音色选择功能优化
- **优先级**：中
- **状态**：待处理
- **描述**：
  - 删除 TTS 关键词
  - 在故事 app 中添加音色选择功能
- **涉及模块**：`app` + `story_control_app` - TTS 设置
- **预计工作量**：中等

### 10. 会话 ID 功能增强
- **优先级**：低
- **状态**：✅ 已完成
- **描述**：
  - 添加会话 ID 说明（代表什么）
  - 添加复制会话 ID 功能
- **涉及模块**：`app` - 会话管理
- **预计工作量**：低
- **完成时间**：2025-01-XX
- **修改内容**：
  - 随任务15删除账户详情部分，会话ID相关功能（包括说明和复制功能）已一并移除
  - 账户详情卡片（UserDetailsCard）中包含的会话ID显示和复制功能已删除
  - 简化了账号设置页面，移除了会话ID相关功能

### 11. Deepseek 联网搜索功能
- **优先级**：中
- **状态**：✅ 已完成
- **描述**：添加联网搜索功能（老年人可能询问日期、天气等实时信息）
- **涉及模块**：`app` + `backend/routes/chat_routes.py` - AI 对话
- **预计工作量**：高
- **完成时间**：2025-01-XX
- **修改内容**：
  - **后端**：在chat_streaming API中添加联网搜索支持
    - 自动检测用户问题是否需要联网搜索（检测关键词：今天、明天、天气、日期等）
    - 当检测到需要实时信息时，自动启用Deepseek的联网搜索功能（tools参数）
    - 处理tool_calls响应，发送搜索状态更新
  - **前端**：添加联网搜索状态处理
    - 在StreamingAIService中添加onSearchStatus回调接口
    - 在ChatViewModel中实现搜索状态处理
    - 支持显示"正在搜索最新信息..."等状态提示
  - **Bug修复**（2025-11-22）：
    - 修复日期相关查询返回400错误的问题
    - 移除手动日期信息处理，改用DeepSeek联网搜索
    - 简化系统提示词处理逻辑
    - 修复Windows环境下日志输出编码错误

### 13. 新话题功能优化
- **优先级**：低
- **状态**：✅ 已完成
- **描述**：将"新话题"按钮文本改为"新对话"（参考deepseek风格）
- **涉及模块**：`app` - 对话管理
- **预计工作量**：低（仅修改文本字段）
- **完成时间**：2025-01-XX

### 18. AI 对话刷新功能优化
- **优先级**：低
- **状态**：✅ 已完成
- **描述**：刷新时变化太小，建议增加 "temperature" 参数以增加变化程度
- **涉及模块**：`app` + `backend/routes/chat_routes.py` - AI 对话
- **预计工作量**：低
- **完成时间**：2025-01-XX
- **修改内容**：
  - **前端**：在StreamingAIService中添加isRefresh参数，刷新请求时传递is_refresh=true
  - **前端**：在ChatViewModel的refreshLastAIResponse方法中，调用startStreamingChat时传递isRefresh=true
  - **后端**：在chat_streaming API中检测is_refresh参数
  - **后端**：刷新请求时使用temperature=0.9（普通请求为0.7），增加回答的变化程度
  - 刷新AI回答时，回答的变化程度明显增加

---

---

## 🔐 登录和设置任务

### 15. 登录时间显示问题修复
- **优先级**：中
- **状态**：✅ 已完成
- **描述**：删除设置页面下方的账户详情部分（包含登录时间等信息）
- **涉及模块**：`app` - 账号设置页面
- **预计工作量**：低
- **完成时间**：2025-01-XX
- **修改内容**：
  - 删除AccountSettingsPage中的UserDetailsCard组件显示
  - 移除账户详情卡片（包含会话ID、注册时间、最后登录时间等信息）
  - 保留用户基本信息卡片（头像、用户名、用户ID）

### 16. 登录界面记住账号密码
- **优先级**：中
- **状态**：⏸️ 暂停
- **描述**：添加记住账号密码功能，支持自动填充
- **涉及模块**：`app` - 登录界面
- **预计工作量**：低
- **备注**：暂时不做处理

### 17. TTS 后台播放问题
- **优先级**：低（根据优化难度决定）
- **状态**：⏸️ 暂停
- **描述**：AI 对话（文字转语音）时，如果跳出 app，声音无法在后台继续播放
- **涉及模块**：`app` - TTS 服务
- **预计工作量**：高
- **备注**：暂时不做处理

---

## 📊 任务优先级统计

| 优先级 | 数量 | 任务编号 |
|--------|------|----------|
| 🔴 高 | 4 | 1, 5, 6, 8 |
| 🟡 中 | 9 | 2, 4, 7, 9, 11, 12, 14, 15, 16 |
| 🟢 低 | 5 | 3, 10, 13, 17, 18 |

---

## 📝 备注

- **优先级说明**：
  - 🔴 高：影响核心功能或用户体验的关键问题
  - 🟡 中：重要改进，但不影响基本使用
  - 🟢 低：可选功能或小优化

- **工作量评估**：
  - 低：1-2小时
  - 中等：半天-1天
  - 高：1-3天

- **状态说明**：
  - ✅ 已完成
  - 🔄 进行中
  - ⏸️ 暂停（暂时不做处理）
  - ⏳ 待处理

---

## 🔄 更新日志

### 2025-01-XX
- ✅ 完成：Story app 完成度计算方式改进（任务12）
  - 进度基于累计滑动距离，而非滚动位置（position）
  - 每次滑动时累加滑动距离（positionDiff），进度 = 累计滑动距离 / 总长度
  - 进度每次最多增长1%，避免过快增长，确保平滑加载
  - 完成按钮仅在进度达到100%时显示
  - 移除了所有时间相关的进度计算（readingDuration、timeProgress等）
  - 移除了倒计时显示（"还需X秒"），不再显示剩余时间
  - 进度更新仅与滑动行为相关，与位置无关
  - 不滑动时，进度不会增长
  - 参考淘宝的完成度计算方式，简化了进度计算逻辑

- ✅ 完成：主题设置添加字体大小选项（任务8）
  - 在设置页面的主题设置词条描述中补充了"字体大小"
  - 将subtitle从"跟随系统、深色模式、亮色模式"更新为"跟随系统、深色模式、亮色模式、字体大小"
  - 用户可以在设置页面看到主题设置包含字体大小选项

- ✅ 完成：会话ID功能增强（任务10）
  - 随任务15删除账户详情部分，会话ID相关功能（包括说明和复制功能）已一并移除
  - 账户详情卡片（UserDetailsCard）中包含的会话ID显示和复制功能已删除
  - 简化了账号设置页面，移除了会话ID相关功能

- ✅ 完成：阅读故事音频轨道问题修复（任务4）
  - 在开始播放前，先释放旧的MediaPlayer实例，防止多个音频轨道同时存在
  - 在退出音频页面时，停止并释放MediaPlayer，而不是只暂停
  - 在音频播放完成或出错时，自动释放MediaPlayer
  - 在故事切换时，释放旧的MediaPlayer
  - 添加DisposableEffect确保组件销毁时释放MediaPlayer
  - 修复了多个MediaPlayer实例同时存在导致的多个音频轨道问题

- ✅ 完成：AI名称一致性修复（任务5）
  - 统一AI名称为"小美"
  - 在文本聊天的系统提示词（SYSTEM_PROMPT）中添加"名字叫小美"
  - 语音通话已使用"小美"名称（bot_name和system_role中）
  - 现在两个界面都统一使用"小美"作为AI名称，保持一致性

- ✅ 完成：AI对话刷新功能优化（任务18）
  - 在StreamingAIService中添加isRefresh参数，刷新请求时传递is_refresh=true
  - 在ChatViewModel的refreshLastAIResponse方法中，调用startStreamingChat时传递isRefresh=true
  - 后端chat_streaming API检测is_refresh参数
  - 刷新请求时使用temperature=0.9（普通请求为0.7），增加回答的变化程度
  - 刷新AI回答时，回答的变化程度明显增加，用户体验更好

- ✅ 完成：登录时间显示问题修复（任务15）
  - 删除设置页面下方的账户详情部分
  - 移除UserDetailsCard组件显示（包含会话ID、注册时间、最后登录时间等信息）
  - 保留用户基本信息卡片（头像、用户名、用户ID）
  - 简化账号设置页面，移除登录时间显示相关的bug

- ✅ 完成：Deepseek联网搜索功能（任务11）
  - 后端自动检测用户问题是否需要联网搜索（日期、天气等实时信息）
  - 自动启用Deepseek的联网搜索功能
  - 前端支持显示搜索状态提示
  - 老年人询问日期、天气等问题时，AI会自动搜索最新信息
  - Bug修复（2025-11-22）：
    - 修复日期相关查询返回400错误的问题
    - 移除手动日期信息处理，改用DeepSeek联网搜索
    - 简化系统提示词处理逻辑
    - 修复Windows环境下日志输出编码错误（locale codec错误）

- ✅ 完成：历史对话图标重新设计（任务14）
  - 删除左上角的设置入口，只保留历史记录按钮
  - 在历史对话抽屉左下角添加设置图标按钮
  - 设置按钮包含图标和文字，类似Deepseek侧边栏风格
  - 点击设置按钮会关闭历史对话抽屉并打开设置页面
  - 为设置按钮添加淡入动画效果（延迟150ms，300ms动画时长）
  - 设计放在历史对话框内（历史对话下方），参考ChatGPT app

- ✅ 完成：新话题功能优化（任务13）
  - 将"新话题"按钮文本改为"开始新对话"，参考deepseek风格
  - 仅修改文本字段，功能保持不变

- ✅ 完成：语音悬浮球跟随问题修复（任务7）
  - 修复了拖动时"半跟随"的问题
  - 拖动时直接使用原始位置值，不使用动画，实现紧密跟随
  - 拖动结束后使用动画实现平滑的贴边效果
  - 悬浮球现在会紧密跟随手指移动

- ✅ 完成：字体大小差异优化（任务2）
  - AI对话app：增大Medium和Large字体大小，使各档位差异从+4sp增加到+6sp
  - Story app：调整SMALL、MEDIUM、LARGE字体大小，使各档位差异从+2sp增加到+6sp
  - 字体大小差异现在更加明显，用户体验更好

- ✅ 完成：Story app 图标替换为 AI 对话 app 的图标（任务1）
  - 已将主应用（AI对话app）的图标复制到 Story app 的所有 mipmap 目录
  - 删除了 Story app 的 adaptive icon 配置，统一使用传统 PNG 图标
  - 两个 app 现在使用相同的图标

### 2025-01-XX
- 修正任务编号，使其与图片中的18个任务一一对应
- 创建任务清单文档
- 整理18项改进任务
- 按模块和优先级分类

---

## 📊 总体进度

**当前完成进度：77.8% (14/18)**

```
已完成：██████████████████░░ 14/18
```

**按模块统计**：
- 📖 Story App相关：3/3 (100%) - 任务1（图标部分）, 4, 12
- 🎨 UI/UX改进：4/5 (80%) - 任务2, 7, 8, 14
- 🤖 AI对话功能：5/7 (71.4%) - 任务5, 10, 11, 13, 18
- 🔐 登录和设置：1/3 (33.3%) - 任务15

---

*最后更新：2025-01-XX*
