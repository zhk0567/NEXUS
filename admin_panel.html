<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•…äº‹æ§åˆ¶ - ç®¡ç†å‘˜é¢æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .header-actions {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .content {
            padding: 30px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #f0f0f0;
            margin-bottom: 30px;
        }
        
        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
        }
        
        .tab:hover {
            background: #f8f9ff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f8f9ff;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #667eea;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 1rem;
        }
        
        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        
        th {
            background: #f8f9ff;
            font-weight: 600;
            color: #333;
        }
        
        tr:hover {
            background: #f8f9ff;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        
        .status-incomplete {
            background: #f8d7da;
            color: #721c24;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 2px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        
        .password-status {
            display: inline-block;
        }
        
        .password-status .loading-text {
            color: #666;
            font-style: italic;
        }
        
        .password-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .password-info p {
            margin: 0;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .password-display {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .password-text {
            font-family: monospace;
            font-size: 0.9rem;
            color: #495057;
        }
        
        .no-password {
            color: #6c757d;
            font-style: italic;
        }
        
        .error-text {
            color: #dc3545;
            font-size: 0.9rem;
        }
        
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }
        
        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .pagination button:hover {
            background: #f0f0f0;
        }
        
        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        /* å¼¹çª—æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            width: 1200px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
        }
        
        .modal-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
        }
        
        .user-info-section, .stats-section, .progress-section {
            margin-bottom: 30px;
        }
        
        .user-info-section h3, .stats-section h3, .progress-section h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 8px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9ff;
            border-radius: 8px;
        }
        
        .info-item label {
            font-weight: 600;
            color: #4a5568;
            min-width: 100px;
            margin-right: 10px;
        }
        
        .info-item span {
            color: #2d3748;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .progress-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        
        .progress-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .progress-table th {
            background: #f7fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
        }
        
        .progress-table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .progress-table tr:hover {
            background: #f8f9ff;
        }
        
        /* å·¥å…·æ æ ·å¼ */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 8px;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .filters select, .filters input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .filters input {
            min-width: 200px;
        }
        
        .bulk-actions {
            display: flex;
            gap: 10px;
        }
        
        .progress-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .progress-actions .btn {
            padding: 4px 8px;
            font-size: 0.8rem;
        }
        
        
        .selected-row {
            background: #e3f2fd !important;
        }
        
        /* è¯¦æƒ…å¼¹çª—æ ·å¼ */
        .details-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .details-modal-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .details-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .details-modal-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }
        
        .details-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .details-modal-close:hover {
            color: #333;
        }
        
        .details-section {
            margin-bottom: 20px;
        }
        
        .details-section h3 {
            margin: 0 0 10px 0;
            color: #555;
            font-size: 1rem;
        }
        
        .details-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        
        .details-info p {
            margin: 5px 0;
            color: #666;
        }
        
        .details-info strong {
            color: #333;
        }
        
        .progress-timeline {
            margin-top: 15px;
        }
        
        .timeline-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .timeline-item:last-child {
            border-bottom: none;
        }
        
        .timeline-label {
            font-weight: 500;
            color: #555;
        }
        
        .timeline-value {
            color: #666;
        }
        
        /* æ‰¹é‡æ“ä½œå¼¹çª— */
        .bulk-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .bulk-modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .bulk-modal h3 {
            margin: 0 0 20px 0;
            color: #2d3748;
        }
        
        .bulk-options {
            margin-bottom: 20px;
        }
        
        .bulk-option {
            margin-bottom: 15px;
        }
        
        .bulk-option label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }
        
        .bulk-option input, .bulk-option select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .bulk-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-actions">
                <button class="logout-btn" onclick="showLogoutConfirm()">é€€å‡ºç™»å½•</button>
            </div>
            <h1>ğŸ“š æ•…äº‹æ§åˆ¶ç®¡ç†å‘˜é¢æ¿</h1>
            <p>ç®¡ç†æ‰€æœ‰ç”¨æˆ·çš„é˜…è¯»è¿›åº¦å’Œå®ŒæˆçŠ¶æ€</p>
            <p style="font-size: 0.9rem; margin-top: 10px; opacity: 0.8;">âš ï¸ ç³»ç»Ÿä»…å…è®¸ user01-user10 è¿™10ä¸ªè´¦å·ç™»å½•</p>
        </div>
        
        <div class="content">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('overview')">ğŸ“Š æ¦‚è§ˆ</div>
                <div class="tab" onclick="switchTab('users')">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</div>
                <div class="tab" onclick="switchTab('progress')">ğŸ“– é˜…è¯»è¿›åº¦</div>
                <div class="tab" onclick="switchTab('stories')">ğŸ“š æ•…äº‹ç®¡ç†</div>
            </div>
            
            <!-- æ¦‚è§ˆæ ‡ç­¾é¡µ -->
            <div id="overview" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">-</div>
                        <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalStories">-</div>
                        <div class="stat-label">æ€»æ•…äº‹æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completedStories">-</div>
                        <div class="stat-label">å·²å®Œæˆæ•…äº‹</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completionRate">-</div>
                        <div class="stat-label">å®Œæˆç‡</div>
                    </div>
                </div>
            </div>
            
            <!-- ç”¨æˆ·ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="users" class="tab-content">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ç”¨æˆ·å</th>
                                <th>å¯†ç </th>
                                <th>æ³¨å†Œæ—¶é—´</th>
                                <th>æœ€åç™»å½•</th>
                                <th>æ€»æ•…äº‹æ•°</th>
                                <th>å·²å®Œæˆ</th>
                                <th>å®Œæˆç‡</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="8" class="loading">åŠ è½½ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="usersPagination"></div>
            </div>
            
            <!-- é˜…è¯»è¿›åº¦æ ‡ç­¾é¡µ -->
            <div id="progress" class="tab-content">
                <!-- ç­›é€‰å’Œæ“ä½œå·¥å…·æ  -->
                <div class="toolbar">
                    <div class="filters">
                        <select id="userFilter" onchange="applyFilters()">
                            <option value="">æ‰€æœ‰ç”¨æˆ·</option>
                        </select>
                        <select id="statusFilter" onchange="applyFilters()">
                            <option value="">æ‰€æœ‰çŠ¶æ€</option>
                            <option value="completed">å·²å®Œæˆ</option>
                            <option value="incomplete">æœªå®Œæˆ</option>
                        </select>
                        <input type="text" id="storyFilter" placeholder="æœç´¢æ•…äº‹æ ‡é¢˜..." onkeyup="applyFilters()">
                    </div>
                    <div class="bulk-actions">
                        <button class="btn btn-primary" onclick="showBulkActionModal()">æ‰¹é‡æ“ä½œ</button>
                        <button class="btn btn-danger" onclick="bulkDeleteSelected()">æ‰¹é‡åˆ é™¤</button>
                        <button class="btn btn-secondary" onclick="exportProgress()">å¯¼å‡ºæ•°æ®</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                <th>ç”¨æˆ·å</th>
                                <th>æ•…äº‹æ ‡é¢˜</th>
                                <th>è¿›åº¦</th>
                                <th>çŠ¶æ€</th>
                                <th>æœ€åé˜…è¯»</th>
                                <th>å®Œæˆæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="progressTableBody">
                            <tr>
                                <td colspan="8" class="loading">åŠ è½½ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="progressPagination"></div>
            </div>
            
            <!-- æ•…äº‹ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="stories" class="tab-content">
                <!-- æ•…äº‹ç®¡ç†å·¥å…·æ  -->
                <div class="toolbar">
                    <div class="filters">
                        <select id="storyStatusFilter" onchange="applyStoryFilters()">
                            <option value="">æ‰€æœ‰çŠ¶æ€</option>
                            <option value="active">æ´»è·ƒ</option>
                            <option value="inactive">åœç”¨</option>
                        </select>
                        <input type="text" id="storySearchFilter" placeholder="æœç´¢æ•…äº‹æ ‡é¢˜..." onkeyup="applyStoryFilters()">
                    </div>
                    <div class="bulk-actions">
                        <button class="btn btn-primary" onclick="showCreateStoryModal()">â• åˆ›å»ºæ•…äº‹</button>
                        <button class="btn btn-secondary" onclick="refreshStories()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>æ•…äº‹ID</th>
                                <th>æ ‡é¢˜</th>
                                <th>çŠ¶æ€</th>
                                <th>éŸ³é¢‘æ—¶é•¿</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ›´æ–°æ—¶é—´</th>
                                <th>ç‰ˆæœ¬</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="storiesTableBody">
                            <tr>
                                <td colspan="8" class="loading">åŠ è½½ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="storiesPagination"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://172.31.0.2:5000';
        const ADMIN_USER_ID = 'admin_001'; // ç®¡ç†å‘˜ç”¨æˆ·ID
        
        let currentUsersPage = 0;
        let currentProgressPage = 0;
        const pageSize = 20;
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // åŠ è½½å¯¹åº”æ•°æ®
            if (tabName === 'overview') {
                loadOverview();
            } else if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'progress') {
                loadProgress();
            }
        }
        
        // åŠ è½½æ¦‚è§ˆæ•°æ®
        async function loadOverview() {
            try {
                const [usersResponse, progressResponse] = await Promise.all([
                    fetch(`${API_BASE}/api/admin/users?admin_user_id=${ADMIN_USER_ID}&limit=1000`),
                    fetch(`${API_BASE}/api/admin/users/reading-progress?admin_user_id=${ADMIN_USER_ID}&limit=1000`)
                ]);
                
                const usersData = await usersResponse.json();
                const progressData = await progressResponse.json();
                
                if (usersData.success && progressData.success) {
                    const totalUsers = usersData.total_count;
                    const totalStories = progressData.data.total_count;
                    const completedStories = progressData.data.progress_list.filter(p => p.is_completed).length;
                    const completionRate = totalStories > 0 ? ((completedStories / totalStories) * 100).toFixed(1) : 0;
                    
                    document.getElementById('totalUsers').textContent = totalUsers;
                    document.getElementById('totalStories').textContent = totalStories;
                    document.getElementById('completedStories').textContent = completedStories;
                    document.getElementById('completionRate').textContent = completionRate + '%';
                }
            } catch (error) {
                console.error('åŠ è½½æ¦‚è§ˆæ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers() {
            try {
                console.log('Loading users...');
                const url = `${API_BASE}/api/admin/users?admin_user_id=${ADMIN_USER_ID}&limit=1000`; // è·å–æ‰€æœ‰ç”¨æˆ·ç”¨äºç­›é€‰
                console.log('Request URL:', url);
                
                const response = await fetch(url);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    displayUsers(data.users);
                    updateUserFilter(data.users); // æ›´æ–°ç”¨æˆ·ç­›é€‰ä¸‹æ‹‰æ¡†
                    updatePagination('usersPagination', currentUsersPage, Math.ceil(data.total_count / pageSize), loadUsers);
                } else {
                    showError('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('Load users error:', error);
                showError('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨
        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                // ç¡®ä¿æ•°å€¼æ˜¯æ•°å­—ç±»å‹
                const totalStories = parseInt(user.total_stories) || 0;
                const completedStories = parseInt(user.completed_stories) || 0;
                const completionRate = totalStories > 0 ? ((completedStories / totalStories) * 100).toFixed(1) : 0;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>
                        <span class="password-display" id="password-display-${user.user_id}">
                            <span class="loading-text">åŠ è½½ä¸­...</span>
                        </span>
                    </td>
                    <td>${formatDate(user.created_at)}</td>
                    <td>${formatDate(user.last_login_at)}</td>
                    <td>${totalStories}</td>
                    <td>${completedStories}</td>
                    <td>${completionRate}%</td>
                    <td>
                        <button class="btn btn-primary" onclick="viewUserDetails('${user.user_id}')">æŸ¥çœ‹è¯¦æƒ…</button>
                        <button class="btn btn-warning" onclick="showPasswordModal('${user.user_id}', '${user.username}')">å¯†ç ç®¡ç†</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨ååŠ è½½æ‰€æœ‰ç”¨æˆ·çš„å¯†ç 
            setTimeout(() => {
                loadAllUserPasswords();
            }, 500);
        }
        
        // æ›´æ–°ç”¨æˆ·ç­›é€‰ä¸‹æ‹‰æ¡†
        function updateUserFilter(users) {
            const userFilter = document.getElementById('userFilter');
            if (!userFilter) return;
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™"æ‰€æœ‰ç”¨æˆ·"é€‰é¡¹ï¼‰
            userFilter.innerHTML = '<option value="">æ‰€æœ‰ç”¨æˆ·</option>';
            
            // æ·»åŠ ç”¨æˆ·é€‰é¡¹
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.user_id;
                option.textContent = `${user.username} (${user.user_id})`;
                userFilter.appendChild(option);
            });
            
            console.log(`ç”¨æˆ·ç­›é€‰ä¸‹æ‹‰æ¡†å·²æ›´æ–°ï¼ŒåŒ…å« ${users.length} ä¸ªç”¨æˆ·`);
        }
        
        // åŠ è½½é˜…è¯»è¿›åº¦
        async function loadProgress() {
            try {
                console.log('Loading reading progress...');
                
                // åŒæ—¶åŠ è½½ç”¨æˆ·åˆ—è¡¨å’Œé˜…è¯»è¿›åº¦
                const [usersResponse, progressResponse] = await Promise.all([
                    fetch(`${API_BASE}/api/admin/users?admin_user_id=${ADMIN_USER_ID}&limit=1000`),
                    fetch(`${API_BASE}/api/admin/users/reading-progress?admin_user_id=${ADMIN_USER_ID}&limit=${pageSize}&offset=${currentProgressPage * pageSize}`)
                ]);
                
                // å¤„ç†ç”¨æˆ·åˆ—è¡¨
                if (usersResponse.ok) {
                    const usersData = await usersResponse.json();
                    if (usersData.success) {
                        updateUserFilter(usersData.users);
                    }
                }
                
                // å¤„ç†é˜…è¯»è¿›åº¦
                if (!progressResponse.ok) {
                    throw new Error(`HTTP error! status: ${progressResponse.status}`);
                }
                
                const data = await progressResponse.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    displayProgress(data.data.progress_list);
                    updatePagination('progressPagination', currentProgressPage, Math.ceil(data.data.total_count / pageSize), loadProgress);
                } else {
                    showError('åŠ è½½é˜…è¯»è¿›åº¦å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('Load progress error:', error);
                showError('åŠ è½½é˜…è¯»è¿›åº¦å¤±è´¥: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºé˜…è¯»è¿›åº¦
        function displayProgress(progressList) {
            const tbody = document.getElementById('progressTableBody');
            tbody.innerHTML = '';
            
            progressList.forEach((progress, index) => {
                const statusClass = progress.is_completed ? 'status-completed' : 'status-incomplete';
                const statusText = progress.is_completed ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ';
                // ç¡®ä¿reading_progressæ˜¯æ•°å­—ç±»å‹
                const progressValue = parseFloat(progress.reading_progress) || 0;
                const progressPercent = progressValue.toFixed(1);
                
                const row = document.createElement('tr');
                row.id = `progress-row-${index}`;
                row.innerHTML = `
                    <td><input type="checkbox" class="progress-checkbox" data-record-id="${progress.id}" data-user-id="${progress.user_id}" data-story-id="${progress.story_id}"></td>
                    <td>${progress.username || 'æœªçŸ¥ç”¨æˆ·'}</td>
                    <td>${progress.story_title}</td>
                    <td>${progressPercent}%</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${formatDate(progress.last_read_time)}</td>
                    <td>${formatDate(progress.completion_time)}</td>
                    <td>
                        <div class="progress-actions">
                            ${progress.is_completed ? 
                                `<button class="btn btn-danger btn-sm" onclick="updateCompletion('${progress.user_id}', '${progress.story_id}', false)">å–æ¶ˆå®Œæˆ</button>` :
                                `<button class="btn btn-success btn-sm" onclick="updateCompletion('${progress.user_id}', '${progress.story_id}', true)">æ ‡è®°å®Œæˆ</button>`
                            }
                            <button class="btn btn-secondary btn-sm" onclick="viewProgressDetails('${progress.user_id}', '${progress.story_id}')">è¯¦æƒ…</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteRecord(${progress.id}, '${progress.username}', '${progress.story_title}')">åˆ é™¤</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // æ›´æ–°å®ŒæˆçŠ¶æ€
        async function updateCompletion(userId, storyId, isCompleted) {
            if (!confirm(`ç¡®å®šè¦${isCompleted ? 'æ ‡è®°ä¸ºå®Œæˆ' : 'å–æ¶ˆå®ŒæˆçŠ¶æ€'}å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/reading/completion`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        admin_user_id: ADMIN_USER_ID,
                        user_id: userId,
                        story_id: storyId,
                        is_completed: isCompleted
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(data.message);
                    // é‡æ–°åŠ è½½å½“å‰é¡µé¢æ•°æ®
                    if (document.getElementById('progress').classList.contains('active')) {
                        loadProgress();
                    }
                } else {
                    showError('æ“ä½œå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                showError('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }
        
        // æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…
        async function viewUserDetails(userId) {
            try {
                console.log('Loading user details for:', userId);
                const url = `${API_BASE}/api/admin/users/${userId}/details?admin_user_id=${ADMIN_USER_ID}`;
                console.log('Request URL:', url);
                
                const response = await fetch(url);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    showUserDetailsModal(data.user_info, data.reading_progress, data.stats);
                } else {
                    showError('è·å–ç”¨æˆ·è¯¦æƒ…å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('Load user details error:', error);
                showError('è·å–ç”¨æˆ·è¯¦æƒ…å¤±è´¥: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºç”¨æˆ·è¯¦æƒ…å¼¹çª—
        function showUserDetailsModal(userInfo, readingProgress, stats) {
            // åˆ›å»ºå¼¹çª—HTML
            const modalHtml = `
                <div id="userDetailsModal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>ç”¨æˆ·è¯¦æƒ… - ${userInfo.username}</h2>
                            <button class="close-btn" onclick="closeUserDetailsModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="user-info-section">
                                <h3>åŸºæœ¬ä¿¡æ¯</h3>
                                <div class="info-grid">
                                    <div class="info-item">
                                        <label>ç”¨æˆ·ID:</label>
                                        <span>${userInfo.user_id}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>ç”¨æˆ·å:</label>
                                        <span>${userInfo.username}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>æ³¨å†Œæ—¶é—´:</label>
                                        <span>${formatDate(userInfo.created_at)}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>æœ€åç™»å½•:</label>
                                        <span>${formatDate(userInfo.last_login_at)}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>è´¦æˆ·çŠ¶æ€:</label>
                                        <span class="status-badge ${userInfo.is_active ? 'status-completed' : 'status-incomplete'}">
                                            ${userInfo.is_active ? 'æ´»è·ƒ' : 'éæ´»è·ƒ'}
                                        </span>
                                    </div>
                                    <div class="info-item">
                                        <label>è®¾å¤‡ä¿¡æ¯:</label>
                                        <span>${userInfo.device_info || 'æœªçŸ¥'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>åº”ç”¨ç‰ˆæœ¬:</label>
                                        <span>${userInfo.app_version || 'æœªçŸ¥'}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="stats-section">
                                <h3>é˜…è¯»ç»Ÿè®¡</h3>
                                <div class="stats-grid">
                                    <div class="stat-item">
                                        <div class="stat-label">æ€»æ•…äº‹æ•°</div>
                                        <div class="stat-value">${stats.total_stories}</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-label">å·²å®Œæˆ</div>
                                        <div class="stat-value">${stats.completed_stories}</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-label">å®Œæˆç‡</div>
                                        <div class="stat-value">${stats.total_stories > 0 ? ((stats.completed_stories / stats.total_stories) * 100).toFixed(1) : 0}%</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-label">å¹³å‡è¿›åº¦</div>
                                        <div class="stat-value">${stats.avg_progress.toFixed(1)}%</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="progress-section">
                                <h3>é˜…è¯»è¿›åº¦è¯¦æƒ…</h3>
                                <div class="progress-table-container">
                                    <table class="progress-table">
                                        <thead>
                                            <tr>
                                                <th>æ•…äº‹æ ‡é¢˜</th>
                                                <th>è¿›åº¦</th>
                                                <th>çŠ¶æ€</th>
                                                <th>å¼€å§‹æ—¶é—´</th>
                                                <th>æœ€åé˜…è¯»</th>
                                                <th>å®Œæˆæ—¶é—´</th>
                                                <th>é˜…è¯»æ—¶é•¿</th>
                                                <th>æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${readingProgress.map(progress => `
                                                <tr>
                                                    <td>${progress.story_title}</td>
                                                    <td>${parseFloat(progress.reading_progress).toFixed(1)}%</td>
                                                    <td>
                                                        <span class="status-badge ${progress.is_completed ? 'status-completed' : 'status-incomplete'}">
                                                            ${progress.is_completed ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}
                                                        </span>
                                                    </td>
                                                    <td>${formatDate(progress.start_time)}</td>
                                                    <td>${formatDate(progress.last_read_time)}</td>
                                                    <td>${formatDate(progress.completion_time)}</td>
                                                    <td>${formatDuration(progress.reading_duration_seconds)}</td>
                                                    <td>
                                                        ${progress.is_completed ? 
                                                            `<button class="btn btn-danger btn-sm" onclick="updateCompletion('${userInfo.user_id}', '${progress.story_id}', false)">å–æ¶ˆå®Œæˆ</button>` :
                                                            `<button class="btn btn-success btn-sm" onclick="updateCompletion('${userInfo.user_id}', '${progress.story_id}', true)">æ ‡è®°å®Œæˆ</button>`
                                                        }
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeUserDetailsModal()">å…³é—­</button>
                        </div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ å¼¹çª—åˆ°é¡µé¢
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // å…³é—­ç”¨æˆ·è¯¦æƒ…å¼¹çª—
        function closeUserDetailsModal() {
            const modal = document.getElementById('userDetailsModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // æ ¼å¼åŒ–æ—¶é•¿
        function formatDuration(seconds) {
            if (!seconds) return '-';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
            } else if (minutes > 0) {
                return `${minutes}åˆ†é’Ÿ${secs}ç§’`;
            } else {
                return `${secs}ç§’`;
            }
        }
        
        
        // æŸ¥çœ‹è¿›åº¦è¯¦æƒ…
        async function viewProgressDetails(userId, storyId) {
            try {
                // è·å–ç”¨æˆ·è¯¦æƒ…
                const userResponse = await fetch(`${API_BASE}/api/admin/users/${userId}/details?admin_user_id=${ADMIN_USER_ID}`);
                
                if (!userResponse.ok) {
                    showError(`HTTPé”™è¯¯: ${userResponse.status}`);
                    return;
                }
                
                const userData = await userResponse.json();
                console.log('ç”¨æˆ·è¯¦æƒ…APIå“åº”:', userData);
                
                if (!userData.success) {
                    showError('è·å–ç”¨æˆ·è¯¦æƒ…å¤±è´¥: ' + userData.error);
                    return;
                }
                
                const userInfo = userData.user_info || {};
                const stats = userData.stats || {};
                
                // æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯æ˜¯å¦å­˜åœ¨
                if (!userInfo.username) {
                    showError('ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•æ˜¾ç¤ºè¯¦æƒ…');
                    return;
                }
                
                // åˆå¹¶ç”¨æˆ·ä¿¡æ¯å’Œç»Ÿè®¡ä¿¡æ¯
                const fullUserInfo = {
                    ...userInfo,
                    total_stories: stats.total_stories || 0,
                    completed_stories: stats.completed_stories || 0,
                    completion_rate: stats.avg_progress ? stats.avg_progress.toFixed(1) : 0
                };
                
                // ä»å½“å‰é¡µé¢æ•°æ®ä¸­æŸ¥æ‰¾å¯¹åº”çš„è¿›åº¦ä¿¡æ¯
                const progressRows = document.querySelectorAll('#progressTableBody tr');
                let progressInfo = null;
                
                for (let row of progressRows) {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 7) {
                        const rowUserId = row.querySelector('.progress-checkbox')?.getAttribute('data-user-id');
                        const rowStoryId = row.querySelector('.progress-checkbox')?.getAttribute('data-story-id');
                        
                        if (rowUserId === userId && rowStoryId === storyId) {
                            progressInfo = {
                                username: cells[1].textContent,
                                storyTitle: cells[2].textContent,
                                progress: cells[3].textContent,
                                status: cells[4].textContent,
                                lastRead: cells[5].textContent,
                                completionTime: cells[6].textContent
                            };
                            break;
                        }
                    }
                }
                
                if (!progressInfo) {
                    showError('æœªæ‰¾åˆ°å¯¹åº”çš„è¿›åº¦ä¿¡æ¯');
                    return;
                }
                
                // åˆ›å»ºè¯¦æƒ…å¼¹çª—
                showProgressDetailsModal(fullUserInfo, progressInfo, storyId);
                
            } catch (error) {
                console.error('View progress details error:', error);
                showError('è·å–è¯¦æƒ…å¤±è´¥: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºè¿›åº¦è¯¦æƒ…å¼¹çª—
        function showProgressDetailsModal(userInfo, progressInfo, storyId) {
            const modalHtml = `
                <div class="details-modal" id="progressDetailsModal">
                    <div class="details-modal-content">
                        <div class="details-modal-header">
                            <h2 class="details-modal-title">é˜…è¯»è¿›åº¦è¯¦æƒ…</h2>
                            <button class="details-modal-close" onclick="closeProgressDetailsModal()">&times;</button>
                        </div>
                        
                        <div class="details-section">
                            <h3>ç”¨æˆ·ä¿¡æ¯</h3>
                            <div class="details-info">
                                <p><strong>ç”¨æˆ·å:</strong> ${userInfo.username}</p>
                                <p><strong>ç”¨æˆ·ID:</strong> ${userInfo.user_id}</p>
                                <p><strong>æ³¨å†Œæ—¶é—´:</strong> ${formatDate(userInfo.created_at)}</p>
                                <p><strong>æœ€åç™»å½•:</strong> ${formatDate(userInfo.last_login_at)}</p>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <h3>æ•…äº‹ä¿¡æ¯</h3>
                            <div class="details-info">
                                <p><strong>æ•…äº‹æ ‡é¢˜:</strong> ${progressInfo.storyTitle}</p>
                                <p><strong>æ•…äº‹ID:</strong> ${storyId}</p>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <h3>é˜…è¯»è¿›åº¦</h3>
                            <div class="details-info">
                                <p><strong>å½“å‰è¿›åº¦:</strong> ${progressInfo.progress}</p>
                                <p><strong>é˜…è¯»çŠ¶æ€:</strong> ${progressInfo.status}</p>
                                <p><strong>æœ€åé˜…è¯»æ—¶é—´:</strong> ${progressInfo.lastRead}</p>
                                <p><strong>å®Œæˆæ—¶é—´:</strong> ${progressInfo.completionTime === '-' ? 'æœªå®Œæˆ' : progressInfo.completionTime}</p>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <h3>é˜…è¯»ç»Ÿè®¡</h3>
                            <div class="details-info">
                                <p><strong>æ€»æ•…äº‹æ•°:</strong> ${userInfo.total_stories || 0}</p>
                                <p><strong>å·²å®Œæˆæ•…äº‹:</strong> ${userInfo.completed_stories || 0}</p>
                                <p><strong>å®Œæˆç‡:</strong> ${userInfo.completion_rate || 0}%</p>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <h3>æ“ä½œ</h3>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="toggleCompletion('${userInfo.user_id}', '${storyId}')">
                                    ${progressInfo.status.includes('å·²å®Œæˆ') ? 'å–æ¶ˆå®Œæˆ' : 'æ ‡è®°å®Œæˆ'}
                                </button>
                                <button class="btn btn-secondary" onclick="closeProgressDetailsModal()">å…³é—­</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // å…³é—­è¿›åº¦è¯¦æƒ…å¼¹çª—
        function closeProgressDetailsModal() {
            const modal = document.getElementById('progressDetailsModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // åˆ‡æ¢å®ŒæˆçŠ¶æ€
        async function toggleCompletion(userId, storyId) {
            try {
                // ä»å½“å‰é¡µé¢æ•°æ®ä¸­æŸ¥æ‰¾å½“å‰çŠ¶æ€
                const progressRows = document.querySelectorAll('#progressTableBody tr');
                let isCompleted = false;
                
                for (let row of progressRows) {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 7) {
                        const rowUserId = row.querySelector('.progress-checkbox')?.getAttribute('data-user-id');
                        const rowStoryId = row.querySelector('.progress-checkbox')?.getAttribute('data-story-id');
                        
                        if (rowUserId === userId && rowStoryId === storyId) {
                            isCompleted = cells[4].textContent.includes('å·²å®Œæˆ');
                            break;
                        }
                    }
                }
                
                const response = await fetch(`${API_BASE}/api/admin/reading/completion`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        admin_user_id: ADMIN_USER_ID,
                        user_id: userId,
                        story_id: storyId,
                        is_completed: !isCompleted
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(data.message);
                    closeProgressDetailsModal();
                    // é‡æ–°åŠ è½½è¿›åº¦æ•°æ®
                    loadProgress();
                } else {
                    showError('æ“ä½œå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('Toggle completion error:', error);
                showError('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }
        
        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.progress-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
                const row = checkbox.closest('tr');
                if (selectAll.checked) {
                    row.classList.add('selected-row');
                } else {
                    row.classList.remove('selected-row');
                }
            });
        }
        
        // åº”ç”¨ç­›é€‰
        function applyFilters() {
            const userFilter = document.getElementById('userFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const storyFilter = document.getElementById('storyFilter').value.toLowerCase();
            
            const rows = document.querySelectorAll('#progressTableBody tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 7) return; // è·³è¿‡åŠ è½½è¡Œ
                
                const username = cells[1].textContent.toLowerCase();
                const storyTitle = cells[2].textContent.toLowerCase();
                const status = cells[4].textContent.includes('å·²å®Œæˆ') ? 'completed' : 'incomplete';
                
                let show = true;
                
                // ç”¨æˆ·ç­›é€‰ï¼šæ£€æŸ¥ç”¨æˆ·åæ˜¯å¦åŒ…å«ç­›é€‰å€¼ï¼Œæˆ–è€…æ˜¯å¦åŒ¹é…é€‰ä¸­çš„ç”¨æˆ·ID
                if (userFilter) {
                    const selectedOption = document.querySelector(`#userFilter option[value="${userFilter}"]`);
                    const selectedUsername = selectedOption ? selectedOption.textContent.split(' (')[0].toLowerCase() : '';
                    if (!username.includes(selectedUsername) && !username.includes(userFilter.toLowerCase())) {
                        show = false;
                    }
                }
                
                if (statusFilter && status !== statusFilter) {
                    show = false;
                }
                
                if (storyFilter && !storyTitle.includes(storyFilter)) {
                    show = false;
                }
                
                row.style.display = show ? '' : 'none';
            });
        }
        
        // æ˜¾ç¤ºæ‰¹é‡æ“ä½œå¼¹çª—
        function showBulkActionModal() {
            const selectedItems = getSelectedItems();
            if (selectedItems.length === 0) {
                showError('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„é¡¹ç›®');
                return;
            }
            
            const modalHtml = `
                <div id="bulkActionModal" class="bulk-modal">
                    <div class="bulk-modal-content">
                        <h3>æ‰¹é‡æ“ä½œ (${selectedItems.length} é¡¹)</h3>
                        <div class="bulk-options">
                            <div class="bulk-option">
                                <label>æ“ä½œç±»å‹:</label>
                                <select id="bulkActionType">
                                    <option value="mark_completed">æ ‡è®°ä¸ºå®Œæˆ</option>
                                    <option value="mark_incomplete">å–æ¶ˆå®ŒæˆçŠ¶æ€</option>
                                </select>
                            </div>
                        </div>
                        <div class="bulk-modal-footer">
                            <button class="btn btn-secondary" onclick="closeBulkActionModal()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="executeBulkAction()">æ‰§è¡Œ</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
        }
        
        // å…³é—­æ‰¹é‡æ“ä½œå¼¹çª—
        function closeBulkActionModal() {
            const modal = document.getElementById('bulkActionModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // è·å–é€‰ä¸­çš„é¡¹ç›®
        function getSelectedItems() {
            const checkboxes = document.querySelectorAll('.progress-checkbox:checked');
            return Array.from(checkboxes).map(checkbox => ({
                user_id: checkbox.dataset.userId,
                story_id: checkbox.dataset.storyId
            }));
        }
        
        // æ‰§è¡Œæ‰¹é‡æ“ä½œ
        async function executeBulkAction() {
            const selectedItems = getSelectedItems();
            const actionType = document.getElementById('bulkActionType').value;
            
            const operations = selectedItems.map(item => {
                const operation = {
                    type: actionType,
                    user_id: item.user_id,
                    story_id: item.story_id
                };
                
                
                return operation;
            });
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/reading/bulk`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        admin_user_id: ADMIN_USER_ID,
                        operations: operations
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(data.message);
                    closeBulkActionModal();
                    loadProgress(); // é‡æ–°åŠ è½½æ•°æ®
                } else {
                    showError('æ‰¹é‡æ“ä½œå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('Bulk action error:', error);
                showError('æ‰¹é‡æ“ä½œå¤±è´¥: ' + error.message);
            }
        }
        
        // å¯¼å‡ºæ•°æ®
        function exportProgress() {
            const table = document.querySelector('#progress table');
            const rows = Array.from(table.querySelectorAll('tr'));
            
            let csv = 'ç”¨æˆ·å,æ•…äº‹æ ‡é¢˜,è¿›åº¦,çŠ¶æ€,æœ€åé˜…è¯»,å®Œæˆæ—¶é—´\n';
            
            rows.forEach((row, index) => {
                if (index === 0) return; // è·³è¿‡è¡¨å¤´
                
                const cells = row.querySelectorAll('td');
                if (cells.length < 7) return; // è·³è¿‡åŠ è½½è¡Œ
                
                const rowData = [
                    cells[1].textContent.trim(),
                    cells[2].textContent.trim(),
                    cells[3].querySelector('input')?.value || cells[3].textContent.trim(),
                    cells[4].textContent.trim(),
                    cells[5].textContent.trim(),
                    cells[6].textContent.trim()
                ];
                
                csv += rowData.join(',') + '\n';
            });
            
            // ä¸‹è½½CSVæ–‡ä»¶
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `reading_progress_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // æ›´æ–°åˆ†é¡µ
        function updatePagination(containerId, currentPage, totalPages, loadFunction) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'ä¸Šä¸€é¡µ';
            prevBtn.disabled = currentPage === 0;
            prevBtn.onclick = () => {
                if (currentPage > 0) {
                    if (loadFunction === loadUsers) {
                        currentUsersPage--;
                    } else {
                        currentProgressPage--;
                    }
                    loadFunction();
                }
            };
            container.appendChild(prevBtn);
            
            // é¡µç æŒ‰é’®
            for (let i = 0; i < totalPages; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i + 1;
                pageBtn.className = i === currentPage ? 'active' : '';
                pageBtn.onclick = () => {
                    if (loadFunction === loadUsers) {
                        currentUsersPage = i;
                    } else {
                        currentProgressPage = i;
                    }
                    loadFunction();
                };
                container.appendChild(pageBtn);
            }
            
            // ä¸‹ä¸€é¡µæŒ‰é’®
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'ä¸‹ä¸€é¡µ';
            nextBtn.disabled = currentPage === totalPages - 1;
            nextBtn.onclick = () => {
                if (currentPage < totalPages - 1) {
                    if (loadFunction === loadUsers) {
                        currentUsersPage++;
                    } else {
                        currentProgressPage++;
                    }
                    loadFunction();
                }
            };
            container.appendChild(nextBtn);
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.content').insertBefore(errorDiv, document.querySelector('.tabs'));
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }
        
        // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.querySelector('.content').insertBefore(successDiv, document.querySelector('.tabs'));
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadOverview();
            loadUsers();
            loadProgress();
            
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°æ•°æ®
            setInterval(() => {
                const activeTab = document.querySelector('.tab.active');
                if (activeTab) {
                    const tabId = activeTab.getAttribute('data-tab');
                    switch(tabId) {
                        case 'overview':
                            loadOverview();
                            break;
                        case 'users':
                            loadUsers();
                            break;
                        case 'progress':
                            loadProgress();
                            break;
                    }
                }
            }, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡
        });
        
        // åˆ é™¤å•æ¡è®°å½•
        async function deleteRecord(recordId, username, storyTitle) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${username}" çš„æ•…äº‹ "${storyTitle}" çš„é˜…è¯»è®°å½•å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/reading/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        admin_user_id: ADMIN_USER_ID,
                        record_id: recordId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(data.message);
                    // é‡æ–°åŠ è½½å½“å‰é¡µé¢æ•°æ®
                    if (document.getElementById('progress').classList.contains('active')) {
                        loadProgress();
                    }
                } else {
                    showError('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                showError('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
        
        // æ‰¹é‡åˆ é™¤é€‰ä¸­çš„è®°å½•
        async function bulkDeleteSelected() {
            const checkboxes = document.querySelectorAll('.progress-checkbox:checked');
            
            if (checkboxes.length === 0) {
                showError('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®°å½•');
                return;
            }
            
            const recordIds = Array.from(checkboxes).map(cb => parseInt(cb.dataset.recordId));
            const recordCount = recordIds.length;
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${recordCount} æ¡è®°å½•å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/reading/bulk-delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        admin_user_id: ADMIN_USER_ID,
                        record_ids: recordIds
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(data.message);
                    // é‡æ–°åŠ è½½å½“å‰é¡µé¢æ•°æ®
                    if (document.getElementById('progress').classList.contains('active')) {
                        loadProgress();
                    }
                } else {
                    showError('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                showError('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
        
        // è·å–ç”¨æˆ·å¯†ç å†…å®¹
        async function loadUserPassword(userId) {
            try {
                const response = await fetch(`${API_BASE}/api/admin/users/${userId}/password?admin_user_id=${ADMIN_USER_ID}`);
                const data = await response.json();
                
                if (data.success) {
                    const passwordInfo = data.password_info;
                    const passwordElement = document.getElementById(`password-display-${userId}`);
                    if (passwordElement) {
                        if (passwordInfo.has_password) {
                            // ç›´æ¥æ˜¾ç¤ºå¯†ç 
                            passwordElement.innerHTML = `<span class="password-text">${passwordInfo.password}</span>`;
                        } else {
                            passwordElement.innerHTML = '<span class="no-password">æœªè®¾ç½®</span>';
                        }
                    }
                } else {
                    const passwordElement = document.getElementById(`password-display-${userId}`);
                    if (passwordElement) {
                        passwordElement.innerHTML = '<span class="error-text">è·å–å¤±è´¥</span>';
                    }
                }
            } catch (error) {
                console.error('è·å–å¯†ç å¤±è´¥:', error);
                const passwordElement = document.getElementById(`password-display-${userId}`);
                if (passwordElement) {
                    passwordElement.innerHTML = '<span class="error-text">é”™è¯¯</span>';
                }
            }
        }
        
        // æ˜¾ç¤ºå¯†ç ç®¡ç†å¼¹çª—
        function showPasswordModal(userId, username) {
            // åˆ›å»ºå¯†ç ç®¡ç†å¼¹çª—
            const modalHtml = `
                <div id="passwordModal" class="modal" style="display: block;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>å¯†ç ç®¡ç† - ${username}</h3>
                            <span class="close" onclick="closePasswordModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="newPassword">æ–°å¯†ç :</label>
                                <input type="password" id="newPassword" placeholder="è¯·è¾“å…¥æ–°å¯†ç " minlength="6">
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword">ç¡®è®¤å¯†ç :</label>
                                <input type="password" id="confirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " minlength="6">
                            </div>
                            <div class="password-info" id="passwordInfo">
                                <p>å¯†ç è¦æ±‚ï¼šè‡³å°‘6ä½å­—ç¬¦</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="resetPassword('${userId}')">é‡ç½®å¯†ç </button>
                            <button class="btn btn-secondary" onclick="closePasswordModal()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ å¼¹çª—åˆ°é¡µé¢
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // å…³é—­å¯†ç ç®¡ç†å¼¹çª—
        function closePasswordModal() {
            const modal = document.getElementById('passwordModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // é‡ç½®ç”¨æˆ·å¯†ç 
        async function resetPassword(userId) {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // éªŒè¯å¯†ç 
            if (!newPassword || newPassword.length < 6) {
                showError('å¯†ç é•¿åº¦è‡³å°‘6ä½');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showError('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦é‡ç½®ç”¨æˆ· ${userId} çš„å¯†ç å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/users/${userId}/password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        admin_user_id: ADMIN_USER_ID,
                        new_password: newPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(data.message);
                    closePasswordModal();
                    // é‡æ–°æ£€æŸ¥å¯†ç çŠ¶æ€
                    checkPasswordStatus(userId);
                } else {
                    showError('å¯†ç é‡ç½®å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                showError('å¯†ç é‡ç½®å¤±è´¥: ' + error.message);
            }
        }
        
        
        // ä¸ºæ‰€æœ‰ç”¨æˆ·åŠ è½½å¯†ç 
        async function loadAllUserPasswords() {
            const passwordElements = document.querySelectorAll('.password-display');
            for (const element of passwordElements) {
                const userId = element.id.replace('password-display-', '');
                await loadUserPassword(userId);
                // æ·»åŠ å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡äºé¢‘ç¹
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }
        
        // ==================== æ•…äº‹ç®¡ç†åŠŸèƒ½ ====================
        
        let storiesData = [];
        let filteredStories = [];
        
        // åŠ è½½æ•…äº‹åˆ—è¡¨
        async function loadStories() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/stories?include_inactive=true`);
                const data = await response.json();
                
                if (data.success) {
                    storiesData = data.stories;
                    filteredStories = [...storiesData];
                    renderStoriesTable();
                } else {
                    showError('åŠ è½½æ•…äº‹åˆ—è¡¨å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åŠ è½½æ•…äº‹åˆ—è¡¨å¤±è´¥:', error);
                showError('åŠ è½½æ•…äº‹åˆ—è¡¨å¤±è´¥: ' + error.message);
            }
        }
        
        // æ¸²æŸ“æ•…äº‹è¡¨æ ¼
        function renderStoriesTable() {
            const tbody = document.getElementById('storiesTableBody');
            if (!tbody) return;
            
            if (filteredStories.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">æš‚æ— æ•…äº‹æ•°æ®</td></tr>';
                return;
            }
            
            tbody.innerHTML = filteredStories.map(story => `
                <tr>
                    <td>${story.story_id}</td>
                    <td>${story.title}</td>
                    <td>
                        <span class="status-badge ${story.is_active ? 'status-completed' : 'status-incomplete'}">
                            ${story.is_active ? 'æ´»è·ƒ' : 'åœç”¨'}
                        </span>
                    </td>
                    <td>${story.audio_duration_seconds ? story.audio_duration_seconds + 'ç§’' : 'æ— '}</td>
                    <td>${new Date(story.created_at).toLocaleString()}</td>
                    <td>${new Date(story.updated_at).toLocaleString()}</td>
                    <td>v${story.version}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editStory('${story.story_id}')">ç¼–è¾‘</button>
                        <button class="btn btn-sm ${story.is_active ? 'btn-warning' : 'btn-success'}" 
                                onclick="${story.is_active ? 'deactivateStory' : 'activateStory'}('${story.story_id}')">
                            ${story.is_active ? 'åœç”¨' : 'æ¿€æ´»'}
                        </button>
                        <button class="btn btn-sm btn-info" onclick="viewStoryDetails('${story.story_id}')">è¯¦æƒ…</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // åº”ç”¨æ•…äº‹ç­›é€‰
        function applyStoryFilters() {
            const statusFilter = document.getElementById('storyStatusFilter').value;
            const searchFilter = document.getElementById('storySearchFilter').value.toLowerCase();
            
            filteredStories = storiesData.filter(story => {
                const matchesStatus = !statusFilter || 
                    (statusFilter === 'active' && story.is_active) ||
                    (statusFilter === 'inactive' && !story.is_active);
                
                const matchesSearch = !searchFilter || 
                    story.title.toLowerCase().includes(searchFilter) ||
                    story.story_id.toLowerCase().includes(searchFilter);
                
                return matchesStatus && matchesSearch;
            });
            
            renderStoriesTable();
        }
        
        // åˆ·æ–°æ•…äº‹åˆ—è¡¨
        function refreshStories() {
            loadStories();
        }
        
        // æ˜¾ç¤ºåˆ›å»ºæ•…äº‹å¼¹çª—
        function showCreateStoryModal() {
            const modalHtml = `
                <div id="createStoryModal" class="modal" style="display: block;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>åˆ›å»ºæ–°æ•…äº‹</h2>
                            <span class="close" onclick="closeModal('createStoryModal')">&times;</span>
                        </div>
                        <div class="modal-body">
                            <form id="createStoryForm">
                                <div class="form-group">
                                    <label for="newStoryId">æ•…äº‹ID:</label>
                                    <input type="text" id="newStoryId" required placeholder="ä¾‹å¦‚: 2024-01-03">
                                </div>
                                <div class="form-group">
                                    <label for="newStoryTitle">æ•…äº‹æ ‡é¢˜:</label>
                                    <input type="text" id="newStoryTitle" required placeholder="è¾“å…¥æ•…äº‹æ ‡é¢˜">
                                </div>
                                <div class="form-group">
                                    <label for="newStoryContent">æ•…äº‹å†…å®¹:</label>
                                    <textarea id="newStoryContent" required rows="10" placeholder="è¾“å…¥æ•…äº‹å†…å®¹..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="newAudioPath">éŸ³é¢‘æ–‡ä»¶è·¯å¾„:</label>
                                    <input type="text" id="newAudioPath" placeholder="ä¾‹å¦‚: story_audio/2024-01-03.mp3">
                                </div>
                                <div class="form-group">
                                    <label for="newAudioDuration">éŸ³é¢‘æ—¶é•¿(ç§’):</label>
                                    <input type="number" id="newAudioDuration" placeholder="ä¾‹å¦‚: 30">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('createStoryModal')">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="createStory()">åˆ›å»º</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // åˆ›å»ºæ•…äº‹
        async function createStory() {
            const storyId = document.getElementById('newStoryId').value;
            const title = document.getElementById('newStoryTitle').value;
            const content = document.getElementById('newStoryContent').value;
            const audioPath = document.getElementById('newAudioPath').value;
            const audioDuration = document.getElementById('newAudioDuration').value;
            
            if (!storyId || !title || !content) {
                showError('æ•…äº‹IDã€æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/stories`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        story_id: storyId,
                        title: title,
                        content: content,
                        audio_file_path: audioPath || null,
                        audio_duration_seconds: audioDuration ? parseInt(audioDuration) : null,
                        created_by: ADMIN_USER_ID
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showSuccess('æ•…äº‹åˆ›å»ºæˆåŠŸ');
                    closeModal('createStoryModal');
                    loadStories();
                } else {
                    showError('åˆ›å»ºæ•…äº‹å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åˆ›å»ºæ•…äº‹å¤±è´¥:', error);
                showError('åˆ›å»ºæ•…äº‹å¤±è´¥: ' + error.message);
            }
        }
        
        // ç¼–è¾‘æ•…äº‹
        function editStory(storyId) {
            const story = storiesData.find(s => s.story_id === storyId);
            if (!story) return;
            
            const modalHtml = `
                <div id="editStoryModal" class="modal" style="display: block;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>ç¼–è¾‘æ•…äº‹: ${story.title}</h2>
                            <span class="close" onclick="closeModal('editStoryModal')">&times;</span>
                        </div>
                        <div class="modal-body">
                            <form id="editStoryForm">
                                <div class="form-group">
                                    <label for="editStoryId">æ•…äº‹ID:</label>
                                    <input type="text" id="editStoryId" value="${story.story_id}" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="editStoryTitle">æ•…äº‹æ ‡é¢˜:</label>
                                    <input type="text" id="editStoryTitle" value="${story.title}" required>
                                </div>
                                <div class="form-group">
                                    <label for="editStoryContent">æ•…äº‹å†…å®¹:</label>
                                    <textarea id="editStoryContent" required rows="10">${story.content}</textarea>
                                </div>
                                <div class="form-group">
                                    <label for="editAudioPath">éŸ³é¢‘æ–‡ä»¶è·¯å¾„:</label>
                                    <input type="text" id="editAudioPath" value="${story.audio_file_path || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="editAudioDuration">éŸ³é¢‘æ—¶é•¿(ç§’):</label>
                                    <input type="number" id="editAudioDuration" value="${story.audio_duration_seconds || ''}">
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="editStoryActive" ${story.is_active ? 'checked' : ''}>
                                        æ¿€æ´»çŠ¶æ€
                                    </label>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('editStoryModal')">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="updateStory('${storyId}')">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // æ›´æ–°æ•…äº‹
        async function updateStory(storyId) {
            const title = document.getElementById('editStoryTitle').value;
            const content = document.getElementById('editStoryContent').value;
            const audioPath = document.getElementById('editAudioPath').value;
            const audioDuration = document.getElementById('editAudioDuration').value;
            const isActive = document.getElementById('editStoryActive').checked;
            
            if (!title || !content) {
                showError('æ•…äº‹æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/stories/${storyId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        audio_file_path: audioPath || null,
                        audio_duration_seconds: audioDuration ? parseInt(audioDuration) : null,
                        is_active: isActive,
                        updated_by: ADMIN_USER_ID
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showSuccess('æ•…äº‹æ›´æ–°æˆåŠŸ');
                    closeModal('editStoryModal');
                    loadStories();
                } else {
                    showError('æ›´æ–°æ•…äº‹å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('æ›´æ–°æ•…äº‹å¤±è´¥:', error);
                showError('æ›´æ–°æ•…äº‹å¤±è´¥: ' + error.message);
            }
        }
        
        // æ¿€æ´»æ•…äº‹
        async function activateStory(storyId) {
            if (!confirm('ç¡®å®šè¦æ¿€æ´»è¿™ä¸ªæ•…äº‹å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/stories/${storyId}/activate`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (data.success) {
                    showSuccess('æ•…äº‹æ¿€æ´»æˆåŠŸ');
                    loadStories();
                } else {
                    showError('æ¿€æ´»æ•…äº‹å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('æ¿€æ´»æ•…äº‹å¤±è´¥:', error);
                showError('æ¿€æ´»æ•…äº‹å¤±è´¥: ' + error.message);
            }
        }
        
        // åœç”¨æ•…äº‹
        async function deactivateStory(storyId) {
            if (!confirm('ç¡®å®šè¦åœç”¨è¿™ä¸ªæ•…äº‹å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/stories/${storyId}/deactivate`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (data.success) {
                    showSuccess('æ•…äº‹åœç”¨æˆåŠŸ');
                    loadStories();
                } else {
                    showError('åœç”¨æ•…äº‹å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åœç”¨æ•…äº‹å¤±è´¥:', error);
                showError('åœç”¨æ•…äº‹å¤±è´¥: ' + error.message);
            }
        }
        
        // æŸ¥çœ‹æ•…äº‹è¯¦æƒ…
        function viewStoryDetails(storyId) {
            const story = storiesData.find(s => s.story_id === storyId);
            if (!story) return;
            
            const modalHtml = `
                <div id="storyDetailsModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h2>æ•…äº‹è¯¦æƒ…: ${story.title}</h2>
                            <span class="close" onclick="closeModal('storyDetailsModal')">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="story-details">
                                <div class="detail-row">
                                    <strong>æ•…äº‹ID:</strong> ${story.story_id}
                                </div>
                                <div class="detail-row">
                                    <strong>æ ‡é¢˜:</strong> ${story.title}
                                </div>
                                <div class="detail-row">
                                    <strong>çŠ¶æ€:</strong> 
                                    <span class="status-badge ${story.is_active ? 'status-completed' : 'status-incomplete'}">
                                        ${story.is_active ? 'æ´»è·ƒ' : 'åœç”¨'}
                                    </span>
                                </div>
                                <div class="detail-row">
                                    <strong>éŸ³é¢‘æ–‡ä»¶:</strong> ${story.audio_file_path || 'æ— '}
                                </div>
                                <div class="detail-row">
                                    <strong>éŸ³é¢‘æ—¶é•¿:</strong> ${story.audio_duration_seconds ? story.audio_duration_seconds + 'ç§’' : 'æ— '}
                                </div>
                                <div class="detail-row">
                                    <strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(story.created_at).toLocaleString()}
                                </div>
                                <div class="detail-row">
                                    <strong>æ›´æ–°æ—¶é—´:</strong> ${new Date(story.updated_at).toLocaleString()}
                                </div>
                                <div class="detail-row">
                                    <strong>ç‰ˆæœ¬:</strong> v${story.version}
                                </div>
                                <div class="detail-row">
                                    <strong>æ•…äº‹å†…å®¹:</strong>
                                    <div class="story-content" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 10px; background: #f9f9f9;">
                                        ${story.content.replace(/\n/g, '<br>')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('storyDetailsModal')">å…³é—­</button>
                            <button class="btn btn-primary" onclick="editStory('${storyId}')">ç¼–è¾‘</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // å…³é—­å¼¹çª—
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }
        
        // æ˜¾ç¤ºé€€å‡ºç™»å½•ç¡®è®¤å¯¹è¯æ¡†
        function showLogoutConfirm() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                logout();
            }
        }
        
        // é€€å‡ºç™»å½•
        async function logout() {
            try {
                // æ¸…é™¤æœ¬åœ°å­˜å‚¨ï¼ˆå¦‚æœæœ‰ï¼‰
                localStorage.clear();
                sessionStorage.clear();
                
                // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                showSuccess('å·²é€€å‡ºç™»å½•');
                
                // å»¶è¿Ÿååˆ·æ–°é¡µé¢ï¼ˆæ¸…é™¤æ‰€æœ‰çŠ¶æ€ï¼‰
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } catch (error) {
                console.error('Logout error:', error);
                showError('é€€å‡ºç™»å½•å¤±è´¥: ' + error.message);
            }
        }
        
        // åœ¨åˆ‡æ¢æ ‡ç­¾é¡µæ—¶åŠ è½½æ•…äº‹æ•°æ®
        function switchTab(tabName) {
            // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾é¡µ
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // å¦‚æœæ˜¯æ•…äº‹ç®¡ç†æ ‡ç­¾é¡µï¼ŒåŠ è½½æ•…äº‹æ•°æ®
            if (tabName === 'stories') {
                loadStories();
            }
        }
    </script>
</body>
</html>
