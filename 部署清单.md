# NEXUS服务器部署清单

## 服务器信息
- **公网IP**: 94.74.95.80
- **内网IP**: 192.168.0.239
- **服务端口**: 5000
- **操作系统**: Windows Server

## 部署步骤

### 1. 环境准备

#### 1.1 Python环境
- [ ] 确认Python版本 >= 3.8
  ```powershell
  python --version
  ```
- [ ] 创建Python虚拟环境（可选但推荐）
  ```powershell
  python -m venv venv
  .\venv\Scripts\Activate.ps1
  ```

#### 1.2 MySQL数据库
- [ ] 确认MySQL已安装（版本 >= 5.7）
  ```powershell
  mysql --version
  ```
- [ ] 确认MySQL服务正在运行
  ```powershell
  Get-Service -Name MySQL*
  ```
- [ ] 检查数据库配置（`database_config.py`）
  - 主机: localhost
  - 端口: 3306
  - 用户: root
  - 密码: 123456（请根据实际情况修改）
  - 数据库: nexus_unified

### 2. 安装Python依赖

- [ ] 安装项目依赖包
  ```powershell
  pip install -r requirements.txt
  ```

**主要依赖包括：**
- Flask 2.3.3（Web框架）
- flask-cors 4.0.0（跨域支持）
- pymysql 1.1.0（MySQL数据库连接）
- edge-tts 7.2.7（语音合成）
- torch 2.1.2（Dolphin ASR模型支持）
- transformers 4.36.2（AI模型）
- 其他依赖见 `requirements.txt`

### 3. 配置更新

- [x] 更新服务器IP配置（`backend/config.py`）
  - PUBLIC_IP: 94.74.95.80
  - PRIVATE_IP: 192.168.0.239

- [ ] 检查数据库配置（`database_config.py`）
  - 确认MySQL用户名和密码正确
  - 确认数据库名称：nexus_unified

- [ ] 检查API密钥配置（`backend/config.py`）
  - DeepSeek API密钥已配置
  - 火山引擎API配置已设置

### 4. 防火墙配置

#### 4.1 Windows防火墙配置

- [ ] 以管理员身份运行PowerShell
- [ ] 执行防火墙配置脚本
  ```powershell
  .\configure_firewall.ps1
  ```
- [ ] 验证防火墙规则
  ```powershell
  Get-NetFirewallRule -DisplayName "NEXUS Server Port 5000"
  ```

**Windows防火墙规则说明：**
- 允许TCP端口5000入站连接
- 允许TCP端口5000出站连接
- 规则名称：NEXUS Server Port 5000

#### 4.2 云服务器安全组配置（重要）

**安全组是云服务器的网络访问控制，必须配置才能允许外部访问！**

根据您的云服务商，在控制台配置安全组规则：

**华为云ECS安全组配置（推荐）：**
1. 登录华为云控制台（https://console.huaweicloud.com）
2. 进入 **弹性云服务器 ECS** -> **网络** -> **安全组**
3. 找到您的ECS实例绑定的安全组，点击安全组名称进入详情
4. 点击 **入方向规则** -> **添加规则**
5. 配置入方向规则：
   - **策略**：允许
   - **协议端口**：TCP:5000
   - **类型**：自定义TCP
   - **端口**：5000
   - **源地址**：0.0.0.0/0（允许所有IP访问，生产环境建议限制为特定IP段）
   - **描述**：NEXUS服务器端口5000
6. 点击 **确定** 保存规则

**验证华为云安全组配置：**
- 配置完成后，从外网测试：`http://94.74.95.80:5000/api/health`
- 如果无法访问，检查：
  1. 安全组规则是否已保存并生效
  2. ECS实例是否绑定了正确的安全组
  3. 网络ACL是否允许该端口（如有配置）

**阿里云ECS安全组配置：**
1. 登录阿里云控制台
2. 进入 ECS实例 -> 网络与安全 -> 安全组
3. 找到实例绑定的安全组，点击"配置规则"
4. 添加入方向规则：
   - 规则方向：入方向
   - 授权策略：允许
   - 协议类型：TCP
   - 端口范围：5000/5000
   - 授权对象：0.0.0.0/0（允许所有IP访问，生产环境建议限制IP）
   - 描述：NEXUS服务器端口5000

**腾讯云CVM安全组配置：**
1. 登录腾讯云控制台
2. 进入 云服务器 -> 安全组
3. 找到实例绑定的安全组，点击"修改规则"
4. 添加入站规则：
   - 类型：自定义
   - 来源：0.0.0.0/0（允许所有IP，生产环境建议限制）
   - 协议端口：TCP:5000
   - 策略：允许
   - 备注：NEXUS服务器端口5000

**AWS EC2安全组配置：**
1. 登录AWS控制台
2. 进入 EC2 -> Security Groups
3. 选择实例绑定的安全组，点击"Inbound rules" -> "Edit inbound rules"
4. 添加规则：
   - Type: Custom TCP
   - Port range: 5000
   - Source: 0.0.0.0/0（或限制特定IP）
   - Description: NEXUS Server Port 5000

**安全组配置要点：**
- ✅ 必须开放TCP端口5000的入站访问
- ✅ 建议同时开放出站访问（通常默认允许）
- ⚠️ 生产环境建议限制授权对象为特定IP或IP段，而非0.0.0.0/0
- ⚠️ 如果使用WebSocket，确保安全组也允许WebSocket连接

### 5. 数据库初始化

- [ ] 数据库会在首次启动时自动初始化
  - 自动创建数据库：nexus_unified
  - 自动创建数据表：users, interactions, reading_progress, story_interactions, system_logs
  - 自动创建默认用户：user01-user10（密码：123456）
  - 自动创建管理员用户：admin（密码：admin123）

**注意：** 如果数据库已存在，初始化过程会跳过已存在的表和用户。

### 6. 启动服务

- [ ] 确认当前目录为项目根目录
  ```powershell
  pwd
  ```
- [ ] 启动Flask服务器
  ```powershell
  python app.py
  ```

**启动后应看到：**
```
🚀 NEXUS后端服务器启动中...
🌐 地址: http://192.168.0.239:5000
📊 管理员面板: http://192.168.0.239:5000/admin
🎤 语音识别: Dolphin ASR（或模拟模式）
🎵 语音合成: edge-tts | 🤖 AI聊天: DeepSeek
✅ 服务器已启动，等待请求...
```

### 7. 验证部署

- [ ] 本地访问测试（服务器本机）
  ```powershell
  # 健康检查
  Invoke-WebRequest -Uri "http://192.168.0.239:5000/api/health"
  # 或
  Invoke-WebRequest -Uri "http://localhost:5000/api/health"
  ```

- [ ] 内网访问测试（同一内网的其他设备）
  ```powershell
  # 从内网其他设备访问
  Invoke-WebRequest -Uri "http://192.168.0.239:5000/api/health"
  ```

- [ ] 公网访问测试（必须配置安全组后才能成功）
  ```powershell
  # 从外网访问（需要安全组已配置）
  Invoke-WebRequest -Uri "http://94.74.95.80:5000/api/health"
  ```

- [ ] 访问管理员面板
  - 内网访问：http://192.168.0.239:5000/admin
  - 公网访问：http://94.74.95.80:5000/admin（需要安全组配置）

**验证步骤：**
1. 先测试本地访问（确保服务正常运行）
2. 再测试内网访问（确保Windows防火墙配置正确）
3. 最后测试公网访问（确保安全组配置正确）

### 8. 服务管理（可选）

#### 8.1 后台运行（使用nssm或任务计划程序）
- [ ] 配置服务自动启动
- [ ] 配置服务自动重启

#### 8.2 日志监控
- [ ] 检查日志文件位置
- [ ] 配置日志轮转

## 服务端点

### API接口
- **健康检查**: `GET /api/health`
- **用户认证**: `POST /api/auth/login`
- **语音识别**: `POST /api/asr/transcribe`
- **语音合成**: `POST /api/tts/synthesize`
- **AI对话**: `POST /api/chat/completion`
- **故事管理**: `GET /api/stories/active`
- **阅读进度**: `POST /api/reading/progress`

### 管理界面
- **管理员面板**: `http://[IP]:5000/admin`

## 测试账号

系统预置了10个测试账号，所有账号密码均为：**123456**

| 用户名 | 密码 |
|--------|------|
| user01 | 123456 |
| user02 | 123456 |
| user03 | 123456 |
| user04 | 123456 |
| user05 | 123456 |
| user06 | 123456 |
| user07 | 123456 |
| user08 | 123456 |
| user09 | 123456 |
| user10 | 123456 |

**管理员账号：**
- 用户名：admin
- 密码：admin123

## 常见问题

### 1. 端口被占用
```powershell
# 检查端口占用
netstat -ano | findstr :5000
# 结束占用进程（替换PID）
taskkill /PID [进程ID] /F
```

### 2. 数据库连接失败
- 检查MySQL服务是否运行
- 检查数据库配置是否正确
- 检查防火墙是否允许MySQL连接

### 3. 依赖安装失败
- 确认网络连接正常
- 尝试使用国内镜像源：
  ```powershell
  pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
  ```

### 4. 防火墙规则未生效
- 确认以管理员身份运行PowerShell
- 检查Windows防火墙服务是否运行
- 手动添加防火墙规则

## 部署完成检查清单

- [ ] Python环境已配置
- [ ] 所有依赖已安装
- [ ] 数据库配置正确
- [ ] IP地址已更新
- [ ] 防火墙规则已配置
- [ ] 服务可以正常启动
- [ ] 健康检查接口正常
- [ ] 管理员面板可以访问
- [ ] 数据库自动初始化成功

## 下一步

部署完成后，可以：
1. 配置Android应用连接到服务器
2. 测试语音识别、AI对话、语音合成功能
3. 配置服务自动启动和监控
4. 根据实际需求调整配置参数

---

**部署日期**: _______________
**部署人员**: _______________
**部署状态**: □ 成功  □ 失败
**备注**: _______________
