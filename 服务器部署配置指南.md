# NEXUS后端服务器部署配置指南

## 服务器信息
- **操作系统**: Windows Server 2022 Standard
- **IP地址**: 172.31.0.2
- **主机名**: APP-BACKEND

---

## 第一步：需要上传到服务器的核心文件

创建一个文件夹（例如：`C:\nexus_backend\`），只上传以下核心文件：

### 必需文件列表
```
nexus_backend.py          # 后端主程序
database_config.py        # 数据库配置文件
database_manager.py       # 数据库管理器
requirements.txt          # Python依赖列表
admin_panel.html          # 管理员面板
start_system.py           # 系统启动脚本
start_admin_panel.py      # 管理员面板启动脚本
```

**注意**：不需要上传以下内容：
- `app/` 目录（Android应用）
- `story_control_app/` 目录（Android应用）
- `miniprogram/` 目录（微信小程序）
- `build/` 目录（构建产物）
- `__pycache__/` 目录（Python缓存）
- `gradle/` 相关文件（Android构建工具）
- 其他文档和脚本

---

## 第二步：安装Anaconda/Miniconda

### 2.1 下载Anaconda
1. 访问 https://www.anaconda.com/products/distribution
2. 下载Windows版本的Anaconda安装程序
3. 运行安装程序，使用默认设置安装

### 2.2 验证安装
打开PowerShell（以管理员身份），执行：
```powershell
conda --version
```
应显示conda版本号。

---

## 第三步：创建Python环境（llasm环境）

### 3.1 接受conda服务条款（首次使用需要）
如果是首次使用conda，需要先接受服务条款。打开PowerShell，执行：
```powershell
conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main
conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r
conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/msys2
```

### 3.2 创建conda环境
执行以下命令创建llasm环境：
```powershell
conda create -n llasm python=3.8 -y
```

### 3.3 激活环境
```powershell
conda activate llasm
```

### 3.4 验证环境
```powershell
python --version
```
应显示：Python 3.8.x

---

## 第四步：安装MySQL数据库

### 4.1 下载MySQL
1. 访问 https://dev.mysql.com/downloads/installer/
2. 下载MySQL Installer for Windows
3. 运行安装程序

### 4.2 安装配置
1. 选择"Server only"安装类型
2. 设置root用户密码（**请记住这个密码**）
3. 完成安装

### 4.3 启动MySQL服务
```powershell
# 检查MySQL服务状态
Get-Service -Name MySQL*

# 如果服务未运行，启动服务
Start-Service -Name MySQL*
```

### 4.4 验证MySQL
```powershell
mysql -u root -p
```
输入密码后，应能成功连接。输入 `EXIT;` 退出。

---

## 第五步：配置防火墙

### 方式1：使用PowerShell（推荐）
1. 按 `Win + X`，选择"Windows PowerShell (管理员)"或"终端 (管理员)"
2. 执行以下命令：
```powershell
# 允许5000端口（后端服务端口）
New-NetFirewallRule -DisplayName "NEXUS Backend" -Direction Inbound -LocalPort 5000 -Protocol TCP -Action Allow

# 允许3306端口（MySQL端口，如果需要远程访问）
New-NetFirewallRule -DisplayName "MySQL" -Direction Inbound -LocalPort 3306 -Protocol TCP -Action Allow
```

### 方式2：使用CMD命令提示符
如果PowerShell命令不可用，可以使用CMD（以管理员身份运行）：
```cmd
# 允许5000端口（后端服务端口）
netsh advfirewall firewall add rule name="NEXUS Backend" dir=in action=allow protocol=TCP localport=5000

# 允许3306端口（MySQL端口，如果需要远程访问）
netsh advfirewall firewall add rule name="MySQL" dir=in action=allow protocol=TCP localport=3306
```

### 方式3：使用图形界面
1. 按 `Win + R`，输入 `wf.msc`，按回车打开"高级安全Windows防火墙"
2. 点击左侧"入站规则"
3. 点击右侧"新建规则"
4. 选择"端口"，点击"下一步"
5. 选择"TCP"，输入"5000"，点击"下一步"
6. 选择"允许连接"，点击"下一步"
7. 全部勾选（域、专用、公用），点击"下一步"
8. 名称输入"NEXUS Backend"，点击"完成"
9. 重复上述步骤，为3306端口创建规则（名称：MySQL）

---

## 第六步：创建数据库

### 6.1 登录MySQL
```powershell
mysql -u root -p
```
输入MySQL root密码。

### 6.2 创建数据库
在MySQL命令行中执行：
```sql
CREATE DATABASE IF NOT EXISTS nexus_unified 
DEFAULT CHARACTER SET utf8mb4 
DEFAULT COLLATE utf8mb4_unicode_ci;

-- 验证数据库创建
SHOW DATABASES;

-- 退出MySQL
EXIT;
```

---

## 第七步：配置数据库连接

### 7.1 编辑database_config.py
打开项目目录中的 `database_config.py` 文件，找到 `DATABASE_CONFIG` 部分，修改：

```python
DATABASE_CONFIG = {
    'host': 'localhost',
    'port': 3306,
    'user': 'root',
    'password': '你的MySQL密码',  # 修改为你的MySQL root密码
    'database': 'nexus_unified',
    'charset': 'utf8mb4',
    'autocommit': True,
    'connect_timeout': 10,
    'read_timeout': 30,
    'write_timeout': 30
}
```

**重要**：将 `'password': 'zhk050607'` 改为你实际的MySQL root密码。

### 7.2 保存文件

---

## 第八步：安装Python依赖

### 8.1 激活llasm环境
```powershell
conda activate llasm
```

### 8.2 进入项目目录
```powershell
cd C:\nexus_backend
# 或你的实际项目路径
```

### 8.3 升级pip
```powershell
python -m pip install --upgrade pip
```

### 8.4 安装依赖包
```powershell
pip install -r requirements.txt
```

**注意**：这个过程可能需要较长时间，特别是torch等大型包。请耐心等待。

### 8.5 验证关键依赖
```powershell
python -c "import flask, flask_cors, pymysql, edge_tts, torch; print('所有依赖安装成功')"
```

如果显示"所有依赖安装成功"，说明依赖安装正确。

---

## 第九步：初始化数据库表

### 9.1 激活llasm环境并进入项目目录
```powershell
conda activate llasm
cd C:\nexus_backend
```

### 9.2 初始化数据库
```powershell
python -c "from database_manager import DatabaseManager; db = DatabaseManager(); db.initialize_database()"
```

### 9.3 验证数据库表
```powershell
mysql -u root -p
```
输入密码后执行：
```sql
USE nexus_unified;
SHOW TABLES;
```
应看到以下表：
- users
- interactions
- user_sessions
- system_logs
- reading_progress
- story_interactions
- admin_operations
- stories

输入 `EXIT;` 退出。

---

## 第十步：创建日志目录

```powershell
# 在项目目录创建logs文件夹
New-Item -ItemType Directory -Path "C:\nexus_backend\logs" -Force
```

---

## 第十一步：测试启动服务

### 11.1 检查端口占用
```powershell
netstat -ano | findstr :5000
```
如果有进程占用，记录PID，然后：
```powershell
taskkill /PID <PID> /F
```

### 11.2 激活环境并启动服务
```powershell
conda activate llasm
cd C:\nexus_backend
python nexus_backend.py
```

如果看到类似以下输出，说明启动成功：
```
 * Running on http://0.0.0.0:5000
```

### 11.3 测试健康检查接口
打开另一个PowerShell窗口，执行：
```powershell
Invoke-WebRequest -Uri http://localhost:5000/api/health
```

或者在浏览器中访问：
```
http://172.31.0.2:5000/api/health
```

应返回JSON格式的健康检查信息。

---

## 第十二步：配置Windows服务（自动启动）

### 12.1 打开任务计划程序
1. 按 `Win + R`
2. 输入 `taskschd.msc`
3. 按回车

### 12.2 创建基本任务
1. 点击右侧"创建基本任务"
2. 名称：`NEXUS Backend`
3. 描述：`NEXUS后端服务自动启动`
4. 点击"下一步"

### 12.3 设置触发器
1. 选择"当计算机启动时"
2. 点击"下一步"

### 12.4 设置操作
1. 选择"启动程序"
2. 点击"下一步"
3. 程序或脚本：`C:\Users\Administrator\anaconda3\Scripts\conda.exe`（**替换为你的conda实际路径**）
4. 添加参数：`run -n llasm python C:\nexus_backend\nexus_backend.py`（**替换为你的项目实际路径**）
5. 起始于：`C:\nexus_backend`（**替换为你的项目实际路径**）
6. 点击"下一步"

**注意**：如果conda路径不在PATH中，需要找到conda.exe的完整路径。通常在：
- `C:\Users\<用户名>\anaconda3\Scripts\conda.exe`
- 或 `C:\ProgramData\anaconda3\Scripts\conda.exe`

### 12.5 完成配置
1. 勾选"当单击完成时，打开此任务属性的对话框"
2. 点击"完成"

### 12.6 配置高级设置
1. 在属性对话框中，勾选：
   - "使用最高权限运行"
   - "即使未登录也运行"
2. 点击"确定"

### 12.7 验证自动启动
1. 重启服务器
2. 等待系统启动完成
3. 检查服务是否自动运行：
```powershell
Invoke-WebRequest -Uri http://localhost:5000/api/health
```

---

## 常用操作命令

### 启动服务
```powershell
conda activate llasm
cd C:\nexus_backend
python nexus_backend.py
```

### 启动系统（包含管理员面板）
```powershell
conda activate llasm
cd C:\nexus_backend
python start_system.py
```

### 启动管理员面板
```powershell
conda activate llasm
cd C:\nexus_backend
python start_admin_panel.py
```

### 停止服务
```powershell
# 查找Python进程
Get-Process python | Where-Object {$_.Path -like "*nexus_backend*"}

# 结束进程（替换<PID>为实际进程ID）
taskkill /PID <PID> /F
```

### 查看日志
```powershell
Get-Content C:\nexus_backend\logs\nexus_backend.log -Tail 50
```

### 备份数据库
```powershell
mysqldump -u root -p nexus_unified > backup_$(Get-Date -Format 'yyyyMMdd_HHmmss').sql
```

---

## 服务地址

- **本地访问**: http://localhost:5000
- **服务器IP**: http://172.31.0.2:5000
- **健康检查**: http://172.31.0.2:5000/api/health
- **管理员面板**: 打开项目目录中的 `admin_panel.html` 文件

---

## 故障排查

### 问题1：conda命令找不到
**解决方案**：
1. 检查Anaconda是否已安装
2. 将conda添加到PATH环境变量
3. 或使用conda的完整路径

### 问题2：Python模块导入失败
**解决方案**：
```powershell
# 确保激活了llasm环境
conda activate llasm

# 重新安装依赖
pip install -r requirements.txt --force-reinstall
```

### 问题3：数据库连接失败
**解决方案**：
1. 检查MySQL服务是否运行：`Get-Service -Name MySQL*`
2. 检查database_config.py中的密码是否正确
3. 测试数据库连接：
```powershell
conda activate llasm
python -c "import pymysql; conn = pymysql.connect(host='localhost', user='root', password='你的密码'); print('连接成功')"
```

### 问题4：端口被占用
**解决方案**：
```powershell
# 查看5000端口占用情况
netstat -ano | findstr :5000

# 结束占用进程（替换PID为实际进程ID）
taskkill /PID <PID> /F
```

### 问题5：服务无法自动启动
**解决方案**：
1. 检查任务计划程序中的conda路径是否正确
2. 检查项目路径是否正确
3. 查看Windows事件查看器中的错误信息

---

## 完成

部署完成后，后端服务将在 **http://172.31.0.2:5000** 上运行。

**重要提示**：
- 所有Python操作必须在 `llasm` conda环境中进行
- 启动服务前必须激活环境：`conda activate llasm`
- 确保database_config.py中的MySQL密码已正确配置

