# NEXUS 服务监控和自动恢复系统

## 🚀 功能概述

NEXUS后端服务现在配备了完善的监控和自动恢复机制，确保服务的高可用性和稳定性。

## 📊 监控功能

### 1. 健康检查端点
- **URL**: `GET /api/health`
- **功能**: 检查所有服务的健康状态
- **返回**: 整体健康状态和各服务状态

```bash
curl http://192.168.64.85:5000/api/health
```

### 2. 服务指标收集
- **URL**: `GET /api/metrics`
- **功能**: 获取详细的服务性能指标
- **参数**: 
  - `service`: 可选，指定服务名称 (tts/asr/chat/all)

```bash
# 获取所有服务指标
curl http://192.168.64.85:5000/api/metrics

# 获取特定服务指标
curl http://192.168.64.85:5000/api/metrics?service=tts
```

### 3. 系统资源监控
- **功能**: 实时监控CPU、内存、磁盘使用率
- **数据**: 通过 `/api/metrics` 端点获取

## 🔄 自动恢复机制

### 1. 自动恢复触发
- **URL**: `POST /api/recovery/trigger`
- **功能**: 手动触发服务恢复
- **参数**: `{"service": "tts"}`

```bash
curl -X POST http://192.168.64.85:5000/api/recovery/trigger \
  -H "Content-Type: application/json" \
  -d '{"service": "tts"}'
```

### 2. 恢复状态查询
- **URL**: `GET /api/recovery/status`
- **功能**: 查看自动恢复状态和配置

```bash
curl http://192.168.64.85:5000/api/recovery/status
```

## 📈 监控指标说明

### 服务指标
- **total_requests**: 总请求数
- **successful_requests**: 成功请求数
- **failed_requests**: 失败请求数
- **success_rate**: 成功率百分比
- **consecutive_failures**: 连续失败次数
- **avg_response_time**: 平均响应时间
- **last_success**: 最后成功时间
- **last_failure**: 最后失败时间
- **error_types**: 错误类型统计

### 系统指标
- **cpu_percent**: CPU使用率
- **memory_percent**: 内存使用率
- **disk_usage**: 磁盘使用率
- **last_update**: 最后更新时间

## 🎯 自动恢复策略

### 触发条件
- 服务连续失败3次或以上
- 自动恢复功能已启用
- 未达到最大恢复尝试次数(3次)

### 恢复操作
1. **TTS服务恢复**:
   - 清理临时文件
   - 等待服务稳定
   - 测试服务可用性

2. **ASR服务恢复**:
   - 重新初始化模型
   - 测试服务可用性

3. **聊天服务恢复**:
   - 重新建立连接
   - 测试服务可用性

### 监控频率
- 健康检查: 每30秒
- 系统资源: 实时更新
- 自动恢复: 每30秒检查一次

## 🖥️ 监控仪表板

### 使用方式
1. 打开 `monitor_dashboard.html` 文件
2. 在浏览器中查看实时监控数据
3. 支持自动刷新(每30秒)

### 功能特性
- 实时服务状态显示
- 性能指标可视化
- 系统资源监控
- 自动数据刷新
- 响应式设计

## 🧪 测试工具

### 监控功能测试
```bash
python test_monitoring.py
```

测试内容包括:
- 健康检查端点
- 指标收集功能
- TTS服务测试
- 恢复触发功能
- 恢复状态查询
- 系统监控数据

## ⚙️ 配置参数

### TTS配置
```python
TTS_CONFIG = {
    'max_retries': 5,           # 最大重试次数
    'timeout_total': 60,        # 总超时时间
    'timeout_connect': 30,      # 连接超时时间
    'retry_delay': 2,           # 重试延迟
    'max_consecutive_failures': 3,  # 最大连续失败次数
    'recovery_delay': 10        # 恢复延迟时间
}
```

### 监控配置
- 监控间隔: 30秒
- 最大恢复尝试: 3次
- 指标历史记录: 100条
- 健康检查阈值: 连续失败3次

## 🚨 告警机制

### 服务异常告警
- 连续失败3次自动标记为不健康
- 自动触发恢复机制
- 记录详细错误日志

### 系统资源告警
- CPU使用率过高
- 内存使用率过高
- 磁盘空间不足

## 📝 日志记录

### 监控日志
- 服务状态变化
- 恢复操作记录
- 性能指标统计
- 错误详情记录

### 日志级别
- INFO: 正常操作记录
- WARNING: 异常情况警告
- ERROR: 错误详情记录

## 🔧 故障排除

### 常见问题
1. **服务无法启动**: 检查端口占用和依赖安装
2. **监控数据不更新**: 检查服务连接状态
3. **自动恢复失败**: 查看错误日志和配置参数
4. **TTS服务异常**: 检查edge-tts依赖和网络连接

### 调试方法
1. 查看服务日志
2. 使用健康检查端点
3. 运行监控测试脚本
4. 检查系统资源使用情况

## 📞 技术支持

如遇到问题，请:
1. 查看日志文件
2. 运行测试脚本
3. 检查监控仪表板
4. 联系技术支持团队

---

**注意**: 监控系统需要 `psutil` 库支持，请确保已安装:
```bash
pip install psutil
```
